(function(){DETECT=DETECT||{},DETECT.plugins=DETECT.plugins||{};var a=600,b=[{name:"http://img04.taobaocdn.com/tps/i4/T1t._HXjxXXXbGICsI-120-120.jpg",size:886,timeout:a},{name:"http://img01.taobaocdn.com/tps/i1/T1dD_GXhBgXXakeN3e-390-390.jpg",size:6530,timeout:a},{name:"http://img02.taobaocdn.com/tps/i2/T10MfHXidcXXauBRvZ-618-618.jpg",size:15870,timeout:a},{name:"http://img03.taobaocdn.com/tps/i3/T1fr2HXdBdXXbwcy7e-950-950.jpg",size:47613,timeout:a},{name:"http://img04.taobaocdn.com/tps/i4/T1gYrHXjNgXXc1iuUZ-1194-1194.jpg",size:64390,timeout:a}];b.end=b.length,b.start=0;var c={base_url:"",timeout:7e3,exptime:864e5,ignore_num:3,results:[],running:!1,aborted:!1,complete:!1,prefix:function(){var a=this.checktype();DETECT.INFO.network.type=a;var b=this.checkonline();DETECT.INFO.network.online=b;var d=this.getLocal("DETECT_INFO");if(d&&!this.exp()){var e=d.brandwidth,f=d.grade;return DETECT.INFO.network.brandwidth=parseInt(e),DETECT.INFO.network.grade=f,DETECT.utils.print(),console.log("读取localstrage"),void 0}"offline"!=b&&(setTimeout(DETECT.plugins.network.abort,this.timeout),c.defer(c.iterate))},exp:function(){var a=(new Date).getTime(),b=this.getLocal("DETECT_INFO").exptime;return a-b>=this.exptime},getLocal:function(a){var a=localStorage.getItem(a);return null===a||"undefined"===a?null:JSON.parse(a)},setLocal:function(a,b){return b=JSON.stringify(b),localStorage.setItem(a,b)},img_loaded:function(a,c,d){if(!this.results[a]){var e={start:c,end:(new Date).getTime(),t:null,state:d};d&&(e.t=e.end-e.start),this.results[a]=e;var f=this.ignore_num;if(a==f-1){for(var g=[],h={},i=0;f>i;i++)g[i]=1==this.results[i].state?1:0,h[g[i]]=1==g[i]?!0:!1;var j=0;for(var k in h)j++;if(1==j&&h[0]&&0==h[0])return console.log(g),console.log("连续"+f+"次失败，可能已经掉线"),!1}a>=b.end-1||void 0!==this.results[a+1]?this.finish():this.load_img(a+1,this.img_loaded)}},finish:function(){var a=this.calculate(),b=this.grade(a),c=DETECT.INFO.network.type;DETECT.INFO.network.brandwidth=a,DETECT.INFO.network.grade=b,DETECT.utils.print();var d=(new Date).getTime();this.setLocal("DETECT_INFO",{type:c,brandwidth:a,grade:b,exptime:d}),this.complete=!0,this.running=!1},checkonline:function(){var a=navigator.onLine;return navigator.hasOwnProperty("onLine")?a?"online":"offline":!1},checktype:function(){var a=navigator.connection;if(a){var b="";switch(a.type){case a.UNKNOWN:b="UNKNOWN";break;case a.ETHERNET:b="ETHERNET";break;case a.WIFI:b="WIFI";break;case a.CELL_2G:b="2G";break;case a.CELL_3G:b="3G"}return b}return!1},calculate:function(){var a,c=-1,d=0,e=0,f=[],g=this.results;for(i=g.length-1;i>=0&&g[i];i--)null!==g[i].t&&(d++,a=1e3*b[i].size/g[i].t,f.push(a));var h=f.length;for(j=0;h>j;j++)e+=f[j];return c=Math.round(e/h),console.log(d+"次平均网速："+c+"字节/秒，相当于"+8*c/1e3+"Kbps"),c},grade:function(a){var b=8*a;return b>0&&76800>b?"slow":b>=76800&&15e4>b?"medium":b>=15e4?"fast":void 0},defer:function(a){var b=this;return setTimeout(function(){a.call(b),b=null},10)},load_img:function(a,c){var d=this.base_url+b[a].name+"?t="+(new Date).getTime()+Math.random(),e=0,f=0,g=new Image,h=this;g.onload=function(){g.onload=g.onerror=null,g=null,clearTimeout(e),c&&c.call(h,a,f,!0),h=c=null},g.onerror=function(){g.onload=g.onerror=null,g=null,clearTimeout(e),c&&c.call(h,a,f,!1),h=c=null},e=setTimeout(function(){c&&c.call(h,a,f,null)},b[a].timeout),f=(new Date).getTime(),g.src=d},iterate:function(a){return this.aborted?!1:(a?this.finish():this.load_img(b.start,this.img_loaded),void 0)}};DETECT.plugins.network={init:function(a){return DETECT.utils.pluginConfig(c,a,"network"),this.run(),this},run:function(){return c.running=!0,c.prefix(),this},abort:function(){return c.aborted=!0,c.running&&c.finish(),console.log("超过预设时间："+c.timeout),this}}})(window);