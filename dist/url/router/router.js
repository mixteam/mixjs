define("mix/core/0.3.0/url/router/router",["mix/core/0.3.0/base/reset/reset","mix/core/0.3.0/base/class/class","mix/core/0.3.0/url/history/history","mix/core/0.3.0/base/message/message"],function(e,t,n){e("mix/core/0.3.0/base/reset/reset");var r=e("mix/core/0.3.0/base/class/class"),i=e("mix/core/0.3.0/url/history/history").singleton,s=/\:\w+/g,o=/\*\w+/g,u=/[-[\]{}()+?.,\\^$|#\s]/g,a=/^[^#\/\!]*/;win=window,doc=win.document,his=win.history,head=doc.getElementsByTagName("head")[0],loc=win.location,Router=r.create({initialize:function(e){var t=this;t._options=Object.extend({root:location.pathname.replace(/[^\/]+\.[^\/]+$/,""),appPath:"apps/",defaultApp:"index",maxStateLen:100},e||{}),t._started=!1,t._states=[],t._stateIdx=-1,t._move=null},_routeToRegExp:function(e){return e=e.replace(s,"([^/][^/]*?)").replace(o,"(.*?)"),new RegExp("^"+e+"(!.*?)?$")},_extractParamKeys:function(e){var t=e.match(s),n={};return t&&Object.each(t,function(e,t){n[e.substring(1)]=t}),n},_extractParameters:function(e,t){var n;if(n=e.exec(t))return n.slice(1)},_extractArguments:function(e){var t=e.split("&"),n={};return t.length&&Object.each(t,function(e){var t=e.split("=");n[t[0]]=t[1]}),n},_pushState:function(e,t,n){var r=this,s=r._options,o=s.root,u=s.appPath,a=s.maxStateLen,f=r._states,l=r._stateIdx,c=f[l-1],h=f[l],p=f[l+1],d,v=r._move;r._move=null;if(v&&v==="backward"||!v&&c&&c.fragment===n)v="backward",l==0?f.pop():l--,c?d=c:(d={appname:e,params:[],args:t,fragment:n},f.push(d));else if(v&&v==="forward"||!v&&!p||p.fragment===n)v="forward",l==a-1?f.shift():l++,p?d=p:(d={appname:e,params:[],args:t,fragment:n},f.push(d));r._stateIdx=l;if(!h||h.appname!=d.appname)d.appentry=[o,u,e,"entry.js"].join("/").replace(/\/{2,}/g,"/"),console.log(d.appentry),i.trigger("navigator:"+v,d.appname,d.appentry)},_replaceState:function(e,t,n){var r=this,s=this._states,o=this._stateIdx,u=this._states[o];u.params=t||[],u.paramKeys=u.paramKeys||n||{},i.trigger("navigator:route",u.appname,e)},getState:function(){var e=this,t=this._states,n=this._stateIdx;return this._states[n]},addRoute:function(e,t){var n=this,r=n._extractParamKeys(e),e=n._routeToRegExp(e);i.route(e,function(i){var s=i.split("!"),o=n._extractParameters(e,s[0]);o&&n._replaceState(t,o,r)},!0)},removeRoute:function(e){var t=this,e=t._routeToRegExp(e);i.remove(e)},forward:function(e,t){var n=this,r=n._states,s=n._stateIdx,o=r[s],u=[];n._move="forward";if(e){if(!o||t||o.fragment!==e)t&&Object.each(t,function(e,t){u.push(t+"="+e)}),r.splice(s+1),i.navigate(e+(u.length?"!"+u.join("&"):""))}else his.forward()},backward:function(){var e=this,t=e._stateIdx;if(t<1)return;e._move="backward",his.back()},start:function(e){var t=this,n=Object.extend(t._options,e||{}),r=n.root,s=n.defaultApp;if(t._started)return;r.charAt(r.length-1)!=="/"&&(n.root=r+="/"),i.route(a,function(e){var n=e.split("!"),r=a.exec(n[0])[0]||s,i=t._extractArguments(n[1]||"");t._pushState(r,i,n[0])}),t._started=i.start({root:r,hashChange:!0})}}),Router.singleton=new Router,n.exports=Router});