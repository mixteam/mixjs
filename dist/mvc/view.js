define("#mix/core/0.3.0/mvc/view",["mix/core/0.3.0/base/reset","mix/core/0.3.0/base/class","mix/core/0.3.0/base/message","mix/core/0.3.0/ui/template","component","mix/core/0.3.0/dom/selector","mix/core/0.3.0/dom/event","mix/core/0.3.0/dom/ajax"],function(a,b,c){a("mix/core/0.3.0/base/reset");var d=a("mix/core/0.3.0/base/class"),e=a("mix/core/0.3.0/base/message"),f=a("mix/core/0.3.0/ui/template"),g=a("component"),h=a("mix/core/0.3.0/dom/selector"),i=e.atReg;a("mix/core/0.3.0/dom/event"),a("mix/core/0.3.0/dom/ajax");var j=window;doc=j.document,head=doc.getElementsByTagName("head")[0],undef=void 0,COMP_OPEN_REGEXP=/\<h5\:(\w\w*?)\s([^>]*?)\>/g,COMP_CLOSE_REGEXP=/\<\/h5\:(\w\w*?)\s*\>/g,COMP_SELF_CLOSE_REGEXP=/<component\s([^>]*?)\/>/g;var k=d.create({initialize:function(a,b,c){var f,g,h,i,j,d=this;f=Object.extend({loadTmpl:!1,loadStyle:!1},d.CONFIGS||{}),g=Object.extend({install:"install",render:"render",parse:"parse",update:"update",suspend:"suspend",active:"active",destroy:"destroy"},d.EVENTS||{}),attrs=Object.extend({},d.ATTRS||{}),h=Object.extend({},d.ROUTES||{}),i=Object.extend({},d.ATTACH||{}),j=Object.extend({},d.DATA||{}),compdata=Object.extend({},d.COMPDATA||{}),helper=Object.extend({},d.TMPL_HELPER||{}),partial=Object.extend({},d.TMPL_PARTIAL||{}),d._name=a||f.name,d._controller=b||f.controller,d._viewport=c||f.viewport,d._src={tmpl:f.tmpl,style:f.style,loadTmpl:f.loadTmpl,loadStyle:f.loadStyle},d._attrs=attrs,d._attach=i,d._data=j,d._dataChanged=undef,d._compdata=compdata,d._components={},d._templates=[],d._tmplHelper=helper,d._tmplPartial=partial,d._isInstalling=!1,d._isCompiled=!1,d._isReady=!1,d._isActive=!1,d._bindEvents(g),d._bindRoutes(h),delete d.CONFIGS,delete d.EVENTS,delete d.ATTRS,delete d.ROUTES,delete d.ATTACH,delete d.DATA,delete d.COMPDATA,delete d.TMPL_HELPERS,delete d.TMPL_PARTIAL},_bindEvents:function(a){var b=this,c=0;Object.each(a,function(a,d){Object.isTypeof(a,"Array")||(a=[a]),Object.each(a,function(a){Object.isTypeof(a,"string")&&(a=b[a]),c++,b.on(d,a)})}),b.log("binded "+c+" events")},_bindRoutes:function(a){var b=this,c=0;Object.each(a,function(a,d){Object.isTypeof(a,"Array")||(a=[a]),Object.each(a,function(a){c++,b._route(d,a)})}),b.log("binded "+c+" routes")},_route:function(a,b){var c=this;Object.isTypeof(b,"string")&&(b=c[b]),b&&c.on("route:"+a,k.ready(b))},_bindAttach:function(){var a=this,b=a._attach,c=0;Object.each(b,function(b,d){Object.each(b,function(b,e){c++,a.attach(e,d,b)})}),a.log("binded "+c+" attachs")},_unbindAttach:function(){var a=this;a.disattach()},install:function(){var a=this,b=a._src,d=(a.getViewport(),!1);a._isInstalling||a._isReady||(a._isInstalling=!0,b.loadTmpl!==!1?(d=!0,a._loadTmpl(b.loadTmpl)):b.tmpl&&a._compileTmpl(),b.loadStyle!==!1?(d=!0,a._loadStyle(b.loadStyle)):b.style&&a._compileStyle(),d?a._checkCompiled():a._compiled())},_checkCompiled:function(){var d,a=this,b=a._src,c=a.getViewport();c.addClass("compiling"),d=setInterval(function(){var e=b.tmpl,g=b.style,h=a._isCompiled;!h&&e&&e instanceof f&&g&&g.nodeName&&"style"==g.nodeName.toLowerCase()&&(clearInterval(d),c.removeClass("compiling"),a._compiled())},100)},_loadTmpl:function(a){var b=this,c=b._src;h.get(a,function(a){c.tmpl=a,b._compileTmpl()})},_loadStyle:function(a){var b=this,c=b._src;h.get(a,function(a){c.style=a,b._compileStyle()})},_replaceComponentTag:function(a){return a.replace(COMP_OPEN_REGEXP,'<component cid="$1" $2>').replace(COMP_CLOSE_REGEXP,"</component>").replace(COMP_SELF_CLOSE_REGEXP,"<component $1></component>")},_compileTmpl:function(){var j,a=this,b=a._name,d=(a._components,a._templates),e=a._src,g=e.tmpl,h=a._tmplHelper,i=a._tmplPartial;Object.isTypeof(g,"string")&&(j=a._replaceComponentTag(g),g=new f("template-"+b),g.addHelper(h),g.addPartial(i),g.compile(j),e.tmpl=g),d.push(g)},_compileStyle:function(){var e,a=this,b=a._name,c=a._src,d=c.style;hasLess=!!j.less,Object.isTypeof(d,"string")&&(e=d,d=doc.createElement("style"),d.setAttribute("type",hasLess?"text/less":"text/css"),d.setAttribute("rel","stylesheet"),d.setAttribute("id","stylesheet-view-"+b),d.innerHTML=e),!d.parentNode&&head.appendChild(d),hasLess&&less.refresh("development"===less.env),c.style=d},_compiled:function(){var a=this;a._isInstalling=!1,a._isCompiled=!0,a._bindAttach(),a.render(),a.parse(),a.ready("ready")},getName:function(){var a=this;return a._name},getController:function(){var a=this;return a._controller},getViewport:function(){var a=this,b=a._viewport,c=a._controller;return h(b||"#"+c.getViewport())},getAttr:function(a){var b=this,c=b._attrs;return c[a]},setAttr:function(a,b){var e,c=this,d=c._attrs;return 1===arguments.length&&Object.isTypeof(e=a,"object")?(Object.each(e,function(a,b){c.setAttr(b,a)}),void 0):(d.hasOwnProperty(a)&&(d[a]=b),void 0)},_findDataPath:function(a,b){return Object.each(b,function(b){return a.hasOwnProperty(b)?(a=a[b],void 0):undef}),a},_getData:function(a,b){var d,c=this;return"string"==typeof b&&(b=b.split(".")),d=b.pop(),a=c._findDataPath(a,b),a?a[d]:void 0},_setData:function(a,b,c,d){var f,g,e=this;return!Object.isTypeof(g=b,"object")||g instanceof Array?(c!=undef&&("string"==typeof b&&(b=b.split(".")),f=b.pop(),a=e._findDataPath(a,b),a&&(a[f]=Object.clone(c,!0),d||(b.push(f),dataChanged=e._dataChanged||(e._dataChanged={}),dataChanged[b.join(".")]=a[f]))),void 0):(d=c,Object.each(g,function(a,b){e.setData(b,a,d)}),void 0)},getData:function(a){var b=this;return b._getData(b._data,a)},setData:function(a,b,c){var d=this;d._setData(d._data,a,b,c)},getCompData:function(a){var b=this;return b._getData(b._compdata,a)},setCompData:function(a,b){var c=this;return 1===arguments.length?c._setData(c._compdata,a,!0):c._setData(c._compdata,a,b,!0)},getComponent:function(a){var b=this,c=b._components;return c[a]},newComponent:function(a,b,c,d){var h,e=this,f=e._components;return Object.isTypeof(a,"string")&&(a=g.depos(a)),3===arguments.length&&(d=c,c=null),a&&(h=new a(b,c,d),f[b]=h),h},newTmpl:function(a,b,c){var g,d=this,e=d._templates,b=Object.extend(d._tmplHelper,b||{}),c=Object.extend(d._tmplPartial,c||{});return a?(a=d._replaceComponentTag(a),g=new f("template-runtime-"+Date.now()),g.addHelper(b),g.addPartial(c),g.compile(a),e.push(g),g):void 0},render:function(a){this.trigger("beforeRender");var e,b=this,a=a||b._data,c=b._src,d=c.tmpl;d.all(a),e=b.getViewport(),e.html(""),e.append(d.getNodeList()),b.log("renderd")},parse:function(a){this.trigger("beforeParse");var b=this,a=a||b._compdata,c=b._components,d=b.getViewport(),e=d.find("component");Object.each(e,function(d){var m,n,e=h(d),f=e.attr("cid"),i=e.attr("id"),j=e.attr("name"),k=e.attr("data-bind"),l=b._getData(a,k);m=g.depos(f),m&&(n=new m(i,j,l),n.render(),c[i]=n,e.replaceWith(n.getDom()))}),b.log("parsed")},update:function(a,b){this.trigger("beforeUpdate");var c=this,d=c._dataChanged,e=c._src,f=e.tmpl;a&&b&&(d={},d[a]=b),d&&Object.each(d,function(a,b){f.update(b,a)}),delete c._dataChanged,c.log("updated")},active:function(){this.trigger("beforeActive");var e,a=this,b=b||a._data,c=a._src;c.tmpl,e=a.getViewport(),""===e.html()&&(a._bindAttach(),a.render(),a.parse()),a.ready("actived")},suspend:function(){this.trigger("beforeSuspend");var a=this;a._isActive=!1,a.trigger("suspended")},ready:function(a){var b=this;b._isActive=!0,b._isReady=!0,b.trigger(a||"ready")},destroy:function(){this.trigger("beforeDestroy");var a=this,b=a._src,c=b.style,d=a._components,e=a._templates;a._unbindAttach(),c&&head.removeChild(c),e&&Object.each(e,function(a){a.destroy()}),d&&Object.each(d,function(a){a.destroy()}),delete a._compdata,delete a._data,delete a._attach,delete a._src,delete a._components,a.trigger("destroyed")},attach:function(a,b,c){var g,d=this,e=d.getViewport(),f=arguments.length;Object.isTypeof(c,"string")&&(c=d[c]),g=function(a){c.call(this,a,d)},c&&(3===f?e.on(a,b,g):2===f&&(c=b,e.on(a,g)))},disattach:function(a,b,c){var d=this,e=d.getViewport(),f=arguments.length;c&&(3===f?(Object.isTypeof(c,"string")&&(c=d[c]),e.off(a,b,c)):2===f?(Object.isTypeof(b,"string")&&(b=d[b]||b),e.off(a,b)):1===f?e.off(a):0===f&&e.off())},has:function(a,b){var c=this,d=c._name,e=c._controller;return e.has("@"+d+":"+a,b,c),c},once:function(a,b){var c=this,d=c._name,e=c._controller;return e.once("@"+d+":"+a,b,c),c},on:function(a,b){var c=this,d=c._name,e=c._controller;return e.on("@"+d+":"+a,b,c),c},off:function(a,b){var c=this,d=c._name,e=c._controller;return e.off("@"+d+":"+a,b,c),c},trigger:function(a){var b=this,c=b._name,d=b.getController(),e=Array.make(arguments);i.test(a)||(e[0]="@"+c+":"+e[0]),d.trigger.apply(d,e)},log:function(a){var b=this,c=b._name,d=b._controller;return d.log("@"+c+":"+a),b}});k.ready=function(a){return function(){var b=this,c=b._isReady,d=arguments;c?a.apply(b,d):b.once("ready",function(){a.apply(b,d)})}},c.exports=k});