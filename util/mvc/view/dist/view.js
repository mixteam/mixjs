define("mix/core/util/mvc/view/0.1.0/view",["mix/core/base/reset/1.0.0/reset","mix/core/base/class/1.0.0/class","mix/core/base/message/1.0.0/message","mix/core/ui/template/0.2.0/template","mix/libs/handlebars/1.0.5/handlebars","mix/core/ui/component/0.2.0/component","mix/core/ui/module/0.1.0/module","mix/core/util/dom/selector/1.0.0/selector","mix/core/util/dom/event/1.0.0/event","mix/core/util/dom/ajax/1.0.0/ajax"],function(e,t,n){e("mix/core/base/reset/1.0.0/reset");var r=e("mix/core/base/class/1.0.0/class"),i=e("mix/core/base/message/1.0.0/message"),s=e("mix/core/ui/template/0.2.0/template"),o=e("mix/core/ui/component/0.2.0/component"),u=e("mix/core/util/dom/selector/1.0.0/selector"),a=i.atReg;e("mix/core/util/dom/event/1.0.0/event"),e("mix/core/util/dom/ajax/1.0.0/ajax");var f=window;doc=f.document,head=doc.getElementsByTagName("head")[0],undef=undefined,COMP_OPEN_REGEXP=/\<h5\:(\w\w*?)\s([^>]*?)\>/g,COMP_CLOSE_REGEXP=/\<\/h5\:(\w\w*?)\s*\>/g,COMP_SELF_CLOSE_REGEXP=/<component\s([^>]*?)\/>/g;var l=r.create({initialize:function(e,t,n){var r=this,i=!1,s,o,u,a,f;s=Object.extend({loadTmpl:!1,loadStyle:!1},r.CONFIGS||{}),o=Object.extend({install:"install",render:"render",parse:"parse",update:"update",suspend:"suspend",active:"active",destroy:"destroy"},r.EVENTS||{}),attrs=Object.extend({},r.ATTRS||{}),u=Object.extend({},r.ROUTES||{}),a=Object.extend({},r.ATTACH||{}),f=Object.extend({},r.DATA||{}),compdata=Object.extend({},r.COMPDATA||{}),helper=Object.extend({},r.TMPL_HELPER||{}),partial=Object.extend({},r.TMPL_PARTIAL||{}),r._name=e||s.name,r._controller=t||s.controller,r._viewport=n||s.viewport,r._src={tmpl:s.tmpl,style:s.style,loadTmpl:s.loadTmpl,loadStyle:s.loadStyle},r._attrs=attrs,r._attach=a,r._data=f,r._dataChanged=undef,r._compdata=compdata,r._components={},r._templates=[],r._tmplHelper=helper,r._tmplPartial=partial,r._isInstalling=!1,r._isCompiled=!1,r._isReady=!1,r._isActive=!1,r._bindEvents(o),r._bindRoutes(u),delete r.CONFIGS,delete r.EVENTS,delete r.ATTRS,delete r.ROUTES,delete r.ATTACH,delete r.DATA,delete r.COMPDATA,delete r.TMPL_HELPERS,delete r.TMPL_PARTIAL},_bindEvents:function(e){var t=this,n=0;Object.each(e,function(e,r){Object.isTypeof(e,"Array")||(e=[e]),Object.each(e,function(e){Object.isTypeof(e,"string")&&(e=t[e]),n++,t.on(r,e)})}),t.log("binded "+n+" events")},_bindRoutes:function(e){var t=this,n=0;Object.each(e,function(e,r){Object.isTypeof(e,"Array")||(e=[e]),Object.each(e,function(e){n++,t._route(r,e)})}),t.log("binded "+n+" routes")},_route:function(e,t){var n=this;Object.isTypeof(t,"string")&&(t=n[t]),t&&n.on("route:"+e,l.ready(t))},_bindAttach:function(){var e=this,t=e._attach,n=0;Object.each(t,function(t,r){Object.each(t,function(t,i){n++,e.attach(i,r,t)})}),e.log("binded "+n+" attachs")},_unbindAttach:function(){var e=this;e.disattach()},install:function(){var e=this,t=e._src,n=e.getViewport(),r=!1;if(e._isInstalling||e._isReady)return;e._isInstalling=!0,t.loadTmpl!==!1?(r=!0,e._loadTmpl(t.loadTmpl)):t.tmpl&&e._compileTmpl(),t.loadStyle!==!1?(r=!0,e._loadStyle(t.loadStyle)):t.style&&e._compileStyle(),r?e._checkCompiled():e._compiled()},_checkCompiled:function(){var e=this,t=e._src,n=e.getViewport(),r;n.addClass("compiling"),r=setInterval(function(){var i=t.tmpl,o=t.style,u=e._isCompiled;!u&&i&&i instanceof s&&o&&o.nodeName&&o.nodeName.toLowerCase()=="style"&&(clearInterval(r),n.removeClass("compiling"),e._compiled())},100)},_loadTmpl:function(e){var t=this,n=t._src;u.get(e,function(e){n.tmpl=e,t._compileTmpl()})},_loadStyle:function(e){var t=this,n=t._src;u.get(e,function(e){n.style=e,t._compileStyle()})},_replaceComponentTag:function(e){var t=this;return e.replace(COMP_OPEN_REGEXP,'<component cid="$1" $2>').replace(COMP_CLOSE_REGEXP,"</component>").replace(COMP_SELF_CLOSE_REGEXP,"<component $1></component>")},_compileTmpl:function(){var e=this,t=e._name,n=e._components,r=e._templates,i=e._src,o=i.tmpl,u=e._tmplHelper,a=e._tmplPartial,f;Object.isTypeof(o,"string")&&(f=e._replaceComponentTag(o),o=new s("template-"+t),o.addHelper(u),o.addPartial(a),o.compile(f),i.tmpl=o),r.push(o)},_compileStyle:function(){var e=this,t=e._name,n=e._src,r=n.style,i;hasLess=!!f.less,Object.isTypeof(r,"string")&&(i=r,r=doc.createElement("style"),r.setAttribute("type",hasLess?"text/less":"text/css"),r.setAttribute("rel","stylesheet"),r.setAttribute("id","stylesheet-view-"+t),r.innerHTML=i),!r.parentNode&&head.appendChild(r),hasLess&&less.refresh(less.env==="development"),n.style=r},_compiled:function(){var e=this;e._isInstalling=!1,e._isCompiled=!0,e._bindAttach(),e.render(),e.parse(),e.ready("ready")},getName:function(){var e=this;return e._name},getController:function(){var e=this;return e._controller},getViewport:function(){var e=this,t=e._viewport,n=e._controller;return u(t||"#"+n.getViewport())},getAttr:function(e){var t=this,n=t._attrs;return n[e]},setAttr:function(e,t){var n=this,r=n._attrs,i;if(arguments.length===1&&Object.isTypeof(i=e,"object")){Object.each(i,function(e,t){n.setAttr(t,e)});return}r.hasOwnProperty(e)&&(r[e]=t)},_findDataPath:function(e,t){return Object.each(t,function(t){if(!e.hasOwnProperty(t))return undef;e=e[t]}),e},_getData:function(e,t){var n=this,r;typeof t=="string"&&(t=t.split(".")),r=t.pop(),e=n._findDataPath(e,t);if(e)return e[r]},_setData:function(e,t,n,r){var i=this,s,o;if(!(!Object.isTypeof(o=t,"object")||o instanceof Array)){r=n,Object.each(o,function(e,t){i.setData(t,e,r)});return}if(n==undef)return;typeof t=="string"&&(t=t.split(".")),s=t.pop(),e=i._findDataPath(e,t),e&&(e[s]=Object.clone(n,!0),r||(t.push(s),dataChanged=i._dataChanged||(i._dataChanged={}),dataChanged[t.join(".")]=e[s]))},getData:function(e){var t=this;return t._getData(t._data,e)},setData:function(e,t,n){var r=this;r._setData(r._data,e,t,n)},getCompData:function(e){var t=this;return t._getData(t._compdata,e)},setCompData:function(e,t){var n=this;return arguments.length===1?n._setData(n._compdata,e,!0):n._setData(n._compdata,e,t,!0)},getComponent:function(e){var t=this,n=t._components;return n[e]},newComponent:function(e,t,n,r){var i=this,s=i._components,u;return Object.isTypeof(e,"string")&&(e=o.depos(e)),arguments.length===3&&(r=n,n=null),e&&(u=new e(t,n,r),s[t]=u),u},newTmpl:function(e,t,n){var r=this,i=r._templates,t=Object.extend(r._tmplHelper,t||{}),n=Object.extend(r._tmplPartial,n||{}),o;if(e)return e=r._replaceComponentTag(e),o=new s("template-runtime-"+Date.now()),o.addHelper(t),o.addPartial(n),o.compile(e),i.push(o),o},render:function(e){this.trigger("beforeRender");var t=this,e=e||t._data,n=t._src,r=n.tmpl,i,s;r.all(e),i=t.getViewport(),i.html(""),i.append(r.getNodeList()),t.log("renderd")},parse:function(e){this.trigger("beforeParse");var t=this,e=e||t._compdata,n=t._components,r=t.getViewport(),i=r.find("component");Object.each(i,function(r){var i=u(r),s=i.attr("cid"),a=i.attr("id"),f=i.attr("name"),l=i.attr("data-bind"),c=t._getData(e,l),h,p;h=o.depos(s),h&&(p=new h(a,f,c),p.render(),n[a]=p,i.replaceWith(p.getDom()))}),t.log("parsed")},update:function(e,t){this.trigger("beforeUpdate");var n=this,r=n._dataChanged,i=n._src,s=i.tmpl;e&&t&&(r={},r[e]=t),r&&Object.each(r,function(e,t){s.update(t,e)}),delete n._dataChanged,n.log("updated")},active:function(){this.trigger("beforeActive");var e=this,t=t||e._data,n=e._src,r=n.tmpl,i,s;i=e.getViewport(),i.html()===""&&(e._bindAttach(),e.render(),e.parse()),e.ready("actived")},suspend:function(){this.trigger("beforeSuspend");var e=this;e._isActive=!1,e.trigger("suspended")},ready:function(e){var t=this;t._isActive=!0,t._isReady=!0,t.trigger(e||"ready")},destroy:function(){this.trigger("beforeDestroy");var e=this,t=e._src,n=t.style,r=e._components,i=e._templates;e._unbindAttach(),n&&head.removeChild(n),i&&Object.each(i,function(e){e.destroy()}),r&&Object.each(r,function(e){e.destroy()}),delete e._compdata,delete e._data,delete e._attach,delete e._src,delete e._components,e.trigger("destroyed")},attach:function(e,t,n){var r=this,i=r.getViewport(),s=arguments.length,o;Object.isTypeof(n,"string")&&(n=r[n]),o=function(e){n.call(this,e,r)},n&&(s===3?i.on(e,t,o):s===2&&(n=t,i.on(e,o)))},disattach:function(e,t,n){var r=this,i=r.getViewport(),s=arguments.length;n&&(s===3?(Object.isTypeof(n,"string")&&(n=r[n]),i.off(e,t,n)):s===2?(Object.isTypeof(t,"string")&&(t=r[t]||t),i.off(e,t)):s===1?i.off(e):s===0&&i.off())},has:function(e,t){var n=this,r=n._name,i=n._controller;return i.has("@"+r+":"+e,t,n),n},once:function(e,t){var n=this,r=n._name,i=n._controller;return i.once("@"+r+":"+e,t,n),n},on:function(e,t){var n=this,r=n._name,i=n._controller;return i.on("@"+r+":"+e,t,n),n},off:function(e,t){var n=this,r=n._name,i=n._controller;return i.off("@"+r+":"+e,t,n),n},trigger:function(e){var t=this,n=t._name,r=t.getController(),i=Array.make(arguments);a.test(e)||(i[0]="@"+n+":"+i[0]),r.trigger.apply(r,i)},log:function(e){var t=this,n=t._name,r=t._controller;return r.log("@"+n+":"+e),t}});l.ready=function(e){return function(){var n=this,r=n._isReady,i=arguments;r?e.apply(n,i):n.once("ready",function(){e.apply(n,i)})}},n.exports=l});