define("mix/core/util/router/0.2.0/router",["mix/core/base/reset/1.0.0/reset","mix/core/base/class/1.0.0/class","mix/core/util/history/0.2.0/history","mix/core/base/message/1.0.0/message"],function(e,t,n){e("mix/core/base/reset/1.0.0/reset");var r=e("mix/core/base/class/1.0.0/class"),i=e("mix/core/util/history/0.2.0/history").singleton,s=/\:\w+/g,o=/\*\w+/g,u=/[-[\]{}()+?.,\\^$|#\s]/g,a=/^[^#\/\!]*/;win=window,doc=win.document,his=win.history,head=doc.getElementsByTagName("head")[0],loc=win.location,Router=r.create({initialize:function(e){var t=this;t._options=Object.extend({root:location.pathname.replace(/[^\/]+\.[^\/]+$/,""),appPath:"apps/",defaultApp:"index",stateLimit:100},e||{}),t._started=!1,t._states=[],t._stateIdx=0,t._move=null},_routeToRegExp:function(e){return e=e.replace(s,"([^/][^/]*?)").replace(o,"(.*?)"),new RegExp("^"+e+"(!.*?)?$")},_extractParamKeys:function(e){var t=e.match(s),n={};return t&&Object.each(t,function(e,t){n[e.substring(1)]=t}),n},_extractParameters:function(e,t){var n;if(n=e.exec(t))return n.slice(1)},_extractArguments:function(e){var t=e.split("&"),n={};return t.length&&Object.each(t,function(e){var t=e.split("=");t[0]&&(n[t[0]]=t[1])}),n},_pushState:function(e,t,n){var r=this,s=r._options,o=s.root,u=s.appPath,a=r._move,f=r._states,l=s.stateLimit,c=f.length,h=r._stateIdx,p=f[h-1],d=f[h],v=f[h+1],m={appname:e,fragment:n,args:t,params:[]};a==null&&(Object.keys(t).length===0&&p&&p.fragment===m.fragment?a="backward":a="forward"),a==="backward"?h===0&&c>0?f.unshift(m):h>0&&(h--,m=p):a==="forward"&&(h===l-1?(f.shift(),f.push(m)):h===0&&c===0?f.push(m):Object.keys(t).length===0&&v&&v.fragment===m.fragment?(h++,m=v):(h++,f.splice(h),f.push(m))),r._move=null,r._stateIdx=h;if(!d||d.appname!=m.appname)m.appentry=[o,u,e,"entry.js"].join("/").replace(/\/{2,}/g,"/"),i.trigger("navigator:"+a,m.appname,m.appentry)},_replaceState:function(e,t,n){var r=this,s=this._states,o=this._stateIdx,u=this._states[o];u.params=t||[],u.paramKeys=u.paramKeys||n||{},i.trigger("navigator:route",u.appname,e)},getState:function(){var e=this,t=this._states,n=this._stateIdx;return this._states[n]},addRoute:function(e,t){var n=this,r=n._extractParamKeys(e),e=n._routeToRegExp(e);i.route(e,function(i){var s=i.split("!"),o=n._extractParameters(e,s[0]);o&&n._replaceState(t,o,r)},!0)},removeRoute:function(e){var t=this,e=t._routeToRegExp(e);i.remove(e)},forward:function(e,t){var n=this,r=n._states,s=n._stateIdx,o=r[s]||{},u=[];n._move="forward";if(e){if(t||o.fragment!==e)t&&Object.each(t,function(e,t){u.push(t+"="+e)}),i.navigate(e+(u.length?"!"+u.join("&"):""))}else his.forward()},backward:function(){var e=this,t=e._stateIdx;if(t===0)return;e._move="backward",his.back()},start:function(e){var t=this,n=Object.extend(t._options,e||{}),r=n.root,s=n.defaultApp;if(t._started)return;r.charAt(r.length-1)!=="/"&&(n.root=r+="/"),i.route(a,function(e){var n=e.split("!"),r=a.exec(n[0])[0]||s,i=t._extractArguments(n[1]||"");t._pushState(r,i,n[0])}),t._started=i.start({root:r,hashChange:!0})}}),Router.singleton=new Router,n.exports=Router});